{% extends "base.html" %}

{% block title %}Price Ticket Generator{% endblock %}

{% block content %}
<style>
/* Custom checkbox styling to ensure blue color */
.product-checkbox {
    accent-color: #2563eb; /* Blue-600 */
}

.product-checkbox:checked {
    accent-color: #2563eb;
    background-color: #2563eb;
    border-color: #2563eb;
}
</style>
<div class="bg-white rounded-xl shadow-sm border p-8">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-900 mb-2">Generate Price Tickets</h2>
        <p class="text-gray-600">Select products from the database or add custom tickets</p>
    </div>

    <form method="POST" action="{{ base_url }}{{ url_for('generate_tickets') }}" id="ticketForm">
        <!-- Selection Tools -->
        <div class="flex items-center gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <button type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors" onclick="selectAll()">Select All</button>
            <button type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors" onclick="deselectAll()">Deselect All</button>
            <span class="text-sm font-medium text-gray-600" id="selectionCount">0 selected</span>
        </div>

        <!-- Product Grid -->
        {% if products %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
            {% for product in products %}
            <div class="bg-white border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-300 hover:shadow-md transition-all duration-200 relative" onclick="toggleCard(this, {{ product.id }})">
                <input type="checkbox" 
                       name="product_ids[]" 
                       value="{{ product.id }}" 
                       class="product-checkbox absolute top-3 right-3 w-5 h-5 text-blue-600 bg-white border-2 border-gray-300 rounded focus:ring-blue-500 focus:ring-2 accent-blue-600"
                       onclick="event.stopPropagation(); updateCount();">
                <div class="text-sm font-mono text-blue-600 font-semibold mb-2 pr-8">{{ product.quick_code }}</div>
                <div class="text-sm text-gray-800 mb-2 leading-tight">{{ product.name }}</div>
                <div class="text-lg font-bold text-gray-800">£{{ "%.2f"|format(product.rrp) }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-500">
            <p>No products in database. Add custom tickets below to get started.</p>
        </div>
        {% endif %}

        <!-- Custom Tickets Section -->
        <div class="border-t pt-8">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Add Custom Tickets</h3>
            <p class="text-gray-600 mb-6">Custom tickets are temporary and won't be saved to the database.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="custom_quick_code" class="block text-sm font-medium text-gray-700 mb-2">Quick Code</label>
                    <input type="text" id="custom_quick_code" name="custom_quick_code" placeholder="e.g. ABC123" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="custom_name" class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                    <input type="text" id="custom_name" name="custom_name" placeholder="e.g. Premium Widget" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="custom_rrp" class="block text-sm font-medium text-gray-700 mb-2">RRP</label>
                    <input type="number" id="custom_rrp" name="custom_rrp" step="0.01" min="0" placeholder="e.g. 99.99" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            
            <button type="button" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors" onclick="addCustomTicket()">
                Add Custom Ticket
            </button>

            <!-- Display Custom Tickets -->
            {% if custom_tickets %}
            <div class="mt-6">
                <h4 class="text-lg font-medium text-gray-900 mb-4">Custom Tickets:</h4>
                <div class="space-y-3">
                    {% for ticket in custom_tickets %}
                    <div class="flex items-center justify-between p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center gap-4">
                            <span class="font-mono text-sm font-semibold text-blue-600">{{ ticket.quick_code }}</span>
                            <span class="text-gray-800">{{ ticket.name }}</span>
                            <span class="font-bold text-gray-800">£{{ "%.2f"|format(ticket.rrp) }}</span>
                        </div>
                        <button type="button" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-700 text-sm rounded-md transition-colors" onclick="removeCustomTicket('{{ ticket.id }}')">Remove</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Generate Button -->
        <div class="mt-8 pt-6 border-t">
            <button type="submit" class="w-full px-6 py-4 bg-blue-600 hover:bg-blue-700 text-white text-lg font-semibold rounded-lg transition-colors" id="generateBtn">
                Generate PDF Tickets
            </button>
            
            <!-- Dynamic Message Area -->
            <div id="generateMessage" class="mt-4 hidden">
                <div class="p-4 rounded-lg border flex items-center justify-between" id="messageContent">
                    <span id="messageText"></span>
                    <button type="button" class="ml-4 text-gray-400 hover:text-gray-600" onclick="hideMessage()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Separate forms for custom ticket operations -->
<form method="POST" action="{{ base_url }}{{ url_for('add_custom_ticket') }}" id="customForm" style="display: none;">
    <input type="hidden" name="quick_code" id="hidden_quick_code">
    <input type="hidden" name="name" id="hidden_name">
    <input type="hidden" name="rrp" id="hidden_rrp">
</form>

<!-- Single hidden form for removing custom tickets -->
<form method="POST" action="" id="removeForm" style="display: none;">
    <input type="hidden" name="ticket_id" id="ticket_id_to_remove">
</form>

<script>
function addCustomTicket() {
    // Get values from visible form fields
    const quickCode = document.getElementById('custom_quick_code').value.trim();
    const name = document.getElementById('custom_name').value.trim();
    const rrp = document.getElementById('custom_rrp').value.trim();
    
    // Basic validation
    if (!quickCode) {
        alert('Quick code is required for a custom ticket.');
        return;
    }
    if (!name) {
        alert('Product name is required for a custom ticket.');
        return;
    }
    if (!rrp) {
        alert('RRP is required for a custom ticket.');
        return;
    }
    
    // Transfer values to hidden form and submit
    document.getElementById('hidden_quick_code').value = quickCode;
    document.getElementById('hidden_name').value = name;
    document.getElementById('hidden_rrp').value = rrp;
    document.getElementById('customForm').submit();
    
    // Clear the form fields after submitting
    document.getElementById('custom_quick_code').value = '';
    document.getElementById('custom_name').value = '';
    document.getElementById('custom_rrp').value = '';
}

function removeCustomTicket(ticketId) {
    if (confirm('Are you sure you want to remove this custom ticket?')) {
        const form = document.getElementById('removeForm');
        document.getElementById('ticket_id_to_remove').value = ticketId;
        form.action = "{{ base_url }}{{ url_for('remove_custom_ticket') }}";
        form.submit();
    }
}

function toggleCard(card, productId) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    updateCardStyle(card, checkbox.checked);
    updateCount();
}

function updateCardStyle(card, isChecked) {
    const checkbox = card.querySelector('.product-checkbox');
    
    if (isChecked) {
        // Update card styling
        card.classList.remove('border-gray-200', 'hover:border-blue-300');
        card.classList.add('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
        
        // Update checkbox styling - make it more prominent when checked
        checkbox.classList.remove('border-gray-300', 'bg-white');
        checkbox.classList.add('border-blue-500', 'bg-blue-500');
    } else {
        // Reset card styling
        card.classList.remove('border-blue-500', 'bg-blue-50', 'ring-2', 'ring-blue-200');
        card.classList.add('border-gray-200', 'hover:border-blue-300');
        
        // Reset checkbox styling
        checkbox.classList.remove('border-blue-500', 'bg-blue-500');
        checkbox.classList.add('border-gray-300', 'bg-white');
    }
}

function selectAll() {
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), true);
    });
    updateCount();
}

function deselectAll() {
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), false);
    });
    updateCount();
}

function updateCount() {
    const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
    const customCount = {{ custom_tickets|length }};
    const totalCount = checkedCount + customCount;
    document.getElementById('selectionCount').textContent = totalCount + ' selected';
}

function hideMessage() {
    document.getElementById('generateMessage').classList.add('hidden');
}

function showMessage(text, type = 'success') {
    const messageDiv = document.getElementById('generateMessage');
    const messageContent = document.getElementById('messageContent');
    const messageText = document.getElementById('messageText');
    
    // Set message text
    messageText.textContent = text;
    
    // Set message styling based on type
    messageContent.className = 'p-4 rounded-lg border flex items-center justify-between';
    if (type === 'success') {
        messageContent.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
    } else if (type === 'error') {
        messageContent.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
    }
    
    // Show message
    messageDiv.classList.remove('hidden');
}

// Handle form submission for PDF generation
document.addEventListener('DOMContentLoaded', function() {
    // Initialize card styles and count on page load
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), checkbox.checked);
    });
    updateCount();
    
    // Handle PDF generation form submission
    document.getElementById('ticketForm').addEventListener('submit', function(e) {
        const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
        const customCount = {{ custom_tickets|length }};
        
        if (checkedCount === 0 && customCount === 0) {
            e.preventDefault();
            showMessage('Please select at least one product or add a custom ticket!', 'error');
            return;
        }
        
        // Show loading message
        showMessage('Generating PDF tickets...', 'success');
        
        // Allow form to submit normally (for file download)
        // After a short delay, update the message
        setTimeout(function() {
            const totalCount = checkedCount + customCount;
            showMessage(`Successfully generated tickets for ${totalCount} products! Download should start automatically.`, 'success');
        }, 1000);
    });
});
</script>
{% endblock %}
