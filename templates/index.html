{% extends "base.html" %}

{% block title %}Price Ticket Generator{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold text-white mb-2">Generate Price Tickets</h2>
    <p class="text-gray-300">Select products from the database or add custom tickets</p>
</div>

    <form method="POST" action="{{ url_for('generate_tickets') }}" id="ticketForm">
        <!-- Selection Tools -->
        <div class="flex items-center gap-4 mb-6 p-4 bg-[#1e1e2e] rounded-lg border border-[#6c7086]">
            <button type="button" class="px-4 py-2 bg-[#6c7086] hover:bg-[#89b4fa] text-white rounded-lg font-medium transition-colors" onclick="selectAll()">Select All</button>
            <button type="button" class="px-4 py-2 bg-[#6c7086] hover:bg-[#89b4fa] text-white rounded-lg font-medium transition-colors" onclick="deselectAll()">Deselect All</button>
            <span class="text-sm font-medium text-gray-300" id="selectionCount">0 selected</span>
        </div>

        <!-- Product Grid -->
        {% if products %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
            {% for product in products %}
            <div class="bg-[#1e1e2e] border-2 border-[#6c7086] rounded-lg p-4 cursor-pointer hover:border-[#89b4fa] hover:shadow-md transition-all duration-200 relative" onclick="toggleCard(this, {{ product.id }})">
                <input type="checkbox" 
                       name="product_ids[]" 
                       value="{{ product.id }}" 
                       class="product-checkbox absolute top-3 right-3 w-5 h-5 text-[#89b4fa] bg-[#1e1e2e] border-2 border-[#6c7086] rounded focus:ring-[#89b4fa] focus:ring-2"
                       onclick="event.stopPropagation(); updateCount();">
                <div class="text-sm font-mono text-[#89b4fa] font-semibold mb-2 pr-8">{{ product.quick_code }}</div>
                <div class="text-sm text-gray-200 mb-2 leading-tight">{{ product.name }}</div>
                <div class="text-lg font-bold text-white">£{{ "%.2f"|format(product.rrp) }}</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 text-gray-400">
            <p>No products in database. Add custom tickets below to get started.</p>
        </div>
        {% endif %}

        <!-- Custom Tickets Section -->
        <div class="border-t border-[#6c7086] pt-8">
            <h3 class="text-xl font-semibold text-white mb-2">Add Custom Tickets</h3>
            <p class="text-gray-300 mb-6">Custom tickets are temporary and won't be saved to the database.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div>
                    <label for="custom_quick_code" class="block text-sm font-medium text-gray-300 mb-2">Quick Code</label>
                    <input type="text" id="custom_quick_code" name="custom_quick_code" placeholder="e.g. ABC123" class="w-full px-3 py-2 border border-[#6c7086] bg-[#1e1e2e] text-white rounded-lg focus:ring-2 focus:ring-[#89b4fa] focus:border-[#89b4fa]" onkeypress="handleCustomTicketKeypress(event)">
                </div>
                
                <div>
                    <label for="custom_name" class="block text-sm font-medium text-gray-300 mb-2">Product Name</label>
                    <input type="text" id="custom_name" name="custom_name" placeholder="e.g. Premium Widget" class="w-full px-3 py-2 border border-[#6c7086] bg-[#1e1e2e] text-white rounded-lg focus:ring-2 focus:ring-[#89b4fa] focus:border-[#89b4fa]" onkeypress="handleCustomTicketKeypress(event)">
                </div>
                
                <div>
                    <label for="custom_rrp" class="block text-sm font-medium text-gray-300 mb-2">RRP</label>
                    <input type="number" id="custom_rrp" name="custom_rrp" step="0.01" min="0" placeholder="e.g. 99.99" class="w-full px-3 py-2 border border-[#6c7086] bg-[#1e1e2e] text-white rounded-lg focus:ring-2 focus:ring-[#89b4fa] focus:border-[#89b4fa]" onkeypress="handleCustomTicketKeypress(event)">
                </div>
            </div>
            
            <button type="button" class="px-6 py-2 bg-[#89b4fa] hover:bg-[#7287fd] text-[#1e1e2e] font-bold rounded-lg transition-colors" onclick="addCustomTicketAjax()" id="addCustomBtn">
                Add Custom Ticket
            </button>

            <!-- Display Custom Tickets -->
            <div class="mt-6" id="customTicketsContainer">
                <h4 class="text-lg font-medium text-white mb-4" id="customTicketsHeader" {% if not custom_tickets %}style="display: none;"{% endif %}>Custom Tickets:</h4>
                <div class="space-y-3" id="customTicketsList">
                    {% if custom_tickets %}
                        {% for ticket in custom_tickets %}
                        <div class="flex items-center justify-between p-4 bg-[#1e1e2e] border border-[#89b4fa]/50 rounded-lg" data-ticket-id="{{ ticket.id }}">
                            <div class="flex items-center gap-4">
                                <span class="font-mono text-sm font-semibold text-[#89b4fa]">{{ ticket.quick_code }}</span>
                                <span class="text-gray-200">{{ ticket.name }}</span>
                                <span class="font-bold text-white">£{{ "%.2f"|format(ticket.rrp) }}</span>
                            </div>
                            <button type="button" class="px-3 py-1 bg-red-900/30 hover:bg-red-800/50 text-red-300 text-sm rounded-md transition-colors" onclick="removeCustomTicketAjax('{{ ticket.id }}')">Remove</button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="mt-8 pt-6 border-t border-[#6c7086]">
            <button type="submit" class="w-full px-6 py-4 bg-[#89b4fa] hover:bg-[#7287fd] text-[#1e1e2e] text-lg font-bold rounded-lg transition-colors" id="generateBtn">
                Generate PDF Tickets
            </button>
            
            <!-- Dynamic Message Area -->
            <div id="generateMessage" class="mt-4 hidden">
                <div class="p-4 rounded-lg border flex items-center justify-between" id="messageContent">
                    <span id="messageText"></span>
                    <button type="button" class="ml-4 text-gray-400 hover:text-gray-200" onclick="hideMessage()">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Forms removed - using AJAX now -->

<script>
// AJAX function to add custom ticket
async function addCustomTicketAjax() {
    // Get values from visible form fields
    const quickCode = document.getElementById('custom_quick_code').value.trim();
    const name = document.getElementById('custom_name').value.trim();
    const rrp = document.getElementById('custom_rrp').value.trim();
    
    // Basic validation
    if (!quickCode) {
        showMessage('Quick code is required for a custom ticket.', 'error');
        return;
    }
    if (!name) {
        showMessage('Product name is required for a custom ticket.', 'error');
        return;
    }
    if (!rrp) {
        showMessage('RRP is required for a custom ticket.', 'error');
        return;
    }
    
    // Disable the button to prevent double-submission
    const addBtn = document.getElementById('addCustomBtn');
    const originalText = addBtn.textContent;
    addBtn.disabled = true;
    addBtn.textContent = 'Adding...';
    
    try {
        const response = await fetch('{{ url_for("add_custom_ticket") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quick_code: quickCode,
                name: name,
                rrp: rrp
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add the ticket to the UI
            addTicketToUI(result.ticket);
            
            // Clear the form fields
            document.getElementById('custom_quick_code').value = '';
            document.getElementById('custom_name').value = '';
            document.getElementById('custom_rrp').value = '';
            
            // Update the count
            updateCount();
            
            showMessage(result.message, 'success');
        } else {
            showMessage(result.error || 'Failed to add custom ticket.', 'error');
        }
    } catch (error) {
        console.error('Error adding custom ticket:', error);
        showMessage('Network error adding custom ticket. Please check your connection and try again.', 'error');
    } finally {
        // Re-enable the button
        addBtn.disabled = false;
        addBtn.textContent = originalText;
    }
}

// AJAX function to remove custom ticket
async function removeCustomTicketAjax(ticketId) {
    if (!confirm('Are you sure you want to remove this custom ticket?')) {
        return;
    }
    
    // Find and disable the remove button
    const ticketElement = document.querySelector(`[data-ticket-id="${ticketId}"]`);
    const removeBtn = ticketElement ? ticketElement.querySelector('button') : null;
    
    if (removeBtn) {
        removeBtn.disabled = true;
        removeBtn.textContent = 'Removing...';
    }
    
    try {
        const response = await fetch('{{ url_for("remove_custom_ticket") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                ticket_id: ticketId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove the ticket from the UI
            removeTicketFromUI(ticketId);
            
            // Update the count
            updateCount();
            
            showMessage(result.message, 'success');
        } else {
            // Re-enable button on error
            if (removeBtn) {
                removeBtn.disabled = false;
                removeBtn.textContent = 'Remove';
            }
            showMessage(result.error || 'Failed to remove custom ticket.', 'error');
        }
    } catch (error) {
        // Re-enable button on error
        if (removeBtn) {
            removeBtn.disabled = false;
            removeBtn.textContent = 'Remove';
        }
        console.error('Error removing custom ticket:', error);
        showMessage('Network error removing custom ticket. Please check your connection and try again.', 'error');
    }
}

// Function to add a ticket to the UI
function addTicketToUI(ticket) {
    const ticketsList = document.getElementById('customTicketsList');
    const ticketsHeader = document.getElementById('customTicketsHeader');
    
    // Show the header if it's hidden
    ticketsHeader.style.display = 'block';
    
    // Create the ticket HTML with initial opacity 0 for animation
    const ticketHTML = `
        <div class="flex items-center justify-between p-4 bg-[#1e1e2e] border border-[#89b4fa]/50 rounded-lg opacity-0 transform scale-95 transition-all duration-300" data-ticket-id="${ticket.id}">
            <div class="flex items-center gap-4">
                <span class="font-mono text-sm font-semibold text-[#89b4fa]">${ticket.quick_code}</span>
                <span class="text-gray-200">${ticket.name}</span>
                <span class="font-bold text-white">£${ticket.rrp.toFixed(2)}</span>
            </div>
            <button type="button" class="px-3 py-1 bg-red-900/30 hover:bg-red-800/50 text-red-300 text-sm rounded-md transition-colors" onclick="removeCustomTicketAjax('${ticket.id}')">Remove</button>
        </div>
    `;
    
    // Add the ticket to the list
    ticketsList.insertAdjacentHTML('beforeend', ticketHTML);
    
    // Animate in the new ticket
    const newTicket = ticketsList.lastElementChild;
    setTimeout(() => {
        newTicket.classList.remove('opacity-0', 'scale-95');
        newTicket.classList.add('opacity-100', 'scale-100');
    }, 10);
}

// Function to remove a ticket from the UI
function removeTicketFromUI(ticketId) {
    const ticketElement = document.querySelector(`[data-ticket-id="${ticketId}"]`);
    if (ticketElement) {
        // Animate out the ticket
        ticketElement.classList.add('opacity-0', 'scale-95', 'transform');
        
        setTimeout(() => {
            ticketElement.remove();
            
            // Hide the header if no tickets remain
            const ticketsList = document.getElementById('customTicketsList');
            const ticketsHeader = document.getElementById('customTicketsHeader');
            if (ticketsList.children.length === 0) {
                ticketsHeader.style.display = 'none';
            }
        }, 300);
    }
}

// Handle Enter key press in custom ticket form
function handleCustomTicketKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        addCustomTicketAjax();
    }
}

// Fallback functions for backward compatibility
function addCustomTicket() {
    addCustomTicketAjax();
}

function removeCustomTicket(ticketId) {
    removeCustomTicketAjax(ticketId);
}

function toggleCard(card, productId) {
    const checkbox = card.querySelector('input[type="checkbox"]');
    checkbox.checked = !checkbox.checked;
    updateCardStyle(card, checkbox.checked);
    updateCount();
}

function updateCardStyle(card, isChecked) {
    const checkbox = card.querySelector('.product-checkbox');
    
    if (isChecked) {
        // Update card styling
        card.classList.remove('border-[#6c7086]', 'hover:border-[#89b4fa]');
        card.classList.add('border-[#89b4fa]', 'bg-[#89b4fa]/10', 'ring-2', 'ring-[#89b4fa]/30');
        
        // Update checkbox styling - make it more prominent when checked
        checkbox.classList.remove('border-[#6c7086]', 'bg-[#1e1e2e]');
        checkbox.classList.add('border-[#89b4fa]', 'bg-[#89b4fa]');
    } else {
        // Reset card styling
        card.classList.remove('border-[#89b4fa]', 'bg-[#89b4fa]/10', 'ring-2', 'ring-[#89b4fa]/30');
        card.classList.add('border-[#6c7086]', 'hover:border-[#89b4fa]');
        
        // Reset checkbox styling
        checkbox.classList.remove('border-[#89b4fa]', 'bg-[#89b4fa]');
        checkbox.classList.add('border-[#6c7086]', 'bg-[#1e1e2e]');
    }
}

function selectAll() {
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), true);
    });
    updateCount();
}

function deselectAll() {
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        checkbox.checked = false;
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), false);
    });
    updateCount();
}

function updateCount() {
    const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
    const customCount = document.getElementById('customTicketsList').children.length;
    const totalCount = checkedCount + customCount;
    document.getElementById('selectionCount').textContent = totalCount + ' selected';
}

function hideMessage() {
    document.getElementById('generateMessage').classList.add('hidden');
}

function showMessage(text, type = 'success') {
    const messageDiv = document.getElementById('generateMessage');
    const messageContent = document.getElementById('messageContent');
    const messageText = document.getElementById('messageText');
    
    // Set message text
    messageText.textContent = text;
    
    // Set message styling based on type
    messageContent.className = 'p-4 rounded-lg border flex items-center justify-between';
    if (type === 'success') {
        messageContent.classList.add('bg-green-900/30', 'border-green-500/50', 'text-green-200');
    } else if (type === 'error') {
        messageContent.classList.add('bg-red-900/30', 'border-red-500/50', 'text-red-200');
    }
    
    // Show message
    messageDiv.classList.remove('hidden');
}

// Handle form submission for PDF generation
document.addEventListener('DOMContentLoaded', function() {
    // Initialize card styles and count on page load
    document.querySelectorAll('.product-checkbox').forEach(checkbox => {
        updateCardStyle(checkbox.closest('div[onclick*="toggleCard"]'), checkbox.checked);
    });
    updateCount();
    
    // Handle PDF generation form submission
    document.getElementById('ticketForm').addEventListener('submit', async function(e) {
        const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
        const customCount = document.getElementById('customTicketsList').children.length;
        
        if (checkedCount === 0 && customCount === 0) {
            e.preventDefault();
            showMessage('Please select at least one product or add a custom ticket!', 'error');
            return;
        }
        
        // If there are custom tickets, verify they're in the session before proceeding
        if (customCount > 0) {
            e.preventDefault(); // Prevent default submission temporarily
            
            try {
                const sessionCheck = await fetch('{{ url_for("session_debug") }}');
                const sessionData = await sessionCheck.json();
                
                console.log('Session check:', sessionData);
                
                if (sessionData.custom_tickets_count !== customCount) {
                    showMessage(`Session sync issue detected. Custom tickets in UI: ${customCount}, in session: ${sessionData.custom_tickets_count}. Please try again.`, 'error');
                    return;
                }
                
                // Session is synced, proceed with form submission
                showMessage('Generating PDF tickets...', 'success');
                e.target.submit(); // Submit the form manually
                
                setTimeout(function() {
                    const totalCount = checkedCount + customCount;
                    showMessage(`Successfully generated tickets for ${totalCount} products! Download should start automatically.`, 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Session check failed:', error);
                showMessage('Session verification failed. Please try again.', 'error');
                return;
            }
        } else {
            // No custom tickets, proceed normally
            showMessage('Generating PDF tickets...', 'success');
            
            setTimeout(function() {
                const totalCount = checkedCount + customCount;
                showMessage(`Successfully generated tickets for ${totalCount} products! Download should start automatically.`, 'success');
            }, 1000);
        }
    });
});
</script>
{% endblock %}
